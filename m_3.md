# M3 — Returns & Calendar Utilities

## Purpose

Provide reliable, no–look-ahead return calculations and reusable trading-calendar utilities that integrate cleanly with M0 (repro), M1 (ingest/validation), and M2 (eligibility). These utilities support downstream momentum, ranking, and portfolio modules by standardizing how daily and monthly returns are computed and how trading dates are aligned.

---

## Scope & Principles

- Exchanges: HOSE and HNX common stocks (same universe as M1/M2).
- Period: 2010–2025 (bounded by M1 ingest window and config range).
- No look-ahead: signal-side features and aligned returns must not leak future information; realized forward returns are exposed explicitly and only for evaluation.
- Deterministic: pure Pandas; leverage M0 reproducibility utilities if any randomness is introduced (none expected here).
- Separation of concerns: calendar utilities live next to returns and are reusable by downstream modules (e.g., momentum, rebalance scheduling).
- Integration-first: inputs use M1 schemas; optional gating uses M2 `monthly_universe` and `apply_eligibility`.

---

## Inputs

- Clean OHLCV (from M1):
  - DataFrame indexed by `[date, ticker]` with columns `[open, high, low, close, volume]`.
  - From `src.data_io.load_ohlcv()` and optionally `validate_ohlcv()`; use the cleaned frame for returns.
- Indices calendar (optional, from M1):
  - Long DataFrame `[date, index, close]` from `src.data_io.load_indices()`; used when calendar mode is `vnindex`.
- Monthly eligibility (from M2):
  - DataFrame `[month_end, ticker, eligible]` from `src.filters.monthly_universe()`; used to gate returns to tradable sets.
- Config: no new config files; if needed, reuse `config/data.yml` date bounds to clip before computing returns.

---

## Outputs

- Daily returns (optional):
  - MultiIndex `[date, ticker]` with columns like `ret_1d`, `ret_log_1d` as needed.
- Forward returns for evaluation (optional):
  - MultiIndex `[date, ticker]` with columns `fwd_ret_{h}d` for horizons `h ∈ {1, 5, 21}` (configurable).
- Monthly returns (primary for momentum backtests):
  - DataFrame `[month_end, ticker, ret_1m]` (month-end close-to-close).
- Calendar helpers:
  - Trading grid index, month-end dates on a given grid, nth trading day lookups, trading-day shifts.
- Integration helpers:
  - Returns filtered by eligibility: DataFrame `[month_end, ticker, ret_1m]` limited to `eligible == True` at formation dates.

---

## Logic & Algorithms

### Calendar Construction

- Grid modes:
  - union: `sorted(unique(df.index.get_level_values('date')))` (default; matches M2).
  - vnindex: `VNINDEX` date set derived from `load_indices()`; use as canonical grid.
- Month-ends on grid:
  - For any date series `D`, month-ends are the last available trading day per calendar month in `D`.
- Trading-day shifts:
  - Given grid `G` and date `t ∈ G`, `shift_trading_days(G, t, k)` returns `G[pos(t)+k]` clipped to bounds; vectorized form applied per row.
- Nth trading day in month:
  - Map month -> ordered dates; pick nth (1-based) if present else NA.

### Return Definitions

- Daily simple return: `ret_1d = close_t / close_{t-1} - 1` computed per ticker.
- Daily log return: `log( close_t / close_{t-1} )` per ticker.
- Forward simple return (evaluation only): `fwd_ret_hd = close_{t+h} / close_t - 1` per ticker; never used to form signals at `t`.
- Monthly return (close-to-close): at formation month-end `t_m`, `ret_1m = close_{t_m} / close_{prev_t_m} - 1`, where `prev_t_m` is the previous month-end on the same grid per ticker (requires last available close on or before month-end). Missing prior price yields NA.
- Handling gaps/missing:
  - Use the same grid logic as M2; do not forward-fill prices across days for return calculation except the conventional per-ticker alignment to last available close on or before the target date when computing month-end returns (i.e., use the last observed close at or before `t_m`).
  - Returns on the first observation for a ticker are NA.
- Robustness:
  - Use cleaned prices from M1 `validate_ohlcv()` output to avoid non-positive price artifacts.
  - Respect M1 date clipping and M2 calendar choices when applicable.

### Eligibility Integration (M2)

- To build a tradable return series:
  - Compute `monthly_universe = filters.monthly_universe(flags)`.
  - Compute `monthly_returns` on the same calendar mode used to build `flags`.
  - Join and keep rows where `eligible == True` at formation `month_end`.
  - Optionally, for daily returns, map each row date to its month and filter via `filters.apply_eligibility`.

---

## Parameters & APIs

Proposed new modules under `src/`:

1) `src/calendar.py`

- `build_trading_grid(df: pd.DataFrame, calendar: Literal['union','vnindex'] = 'union', indices_df: pd.DataFrame | None = None) -> pd.DatetimeIndex`
  - Build canonical grid from input OHLCV or VNINDEX dates.

- `month_ends(grid: pd.DatetimeIndex) -> pd.DatetimeIndex`
  - Return last available trading day per calendar month.

- `nth_trading_day_in_month(grid: pd.DatetimeIndex, n: int) -> pd.Series`
  - Map each month to its nth trading date (or NA if fewer than n days).

- `shift_trading_days(grid: pd.DatetimeIndex, dates: pd.DatetimeIndex | pd.Series, k: int) -> pd.DatetimeIndex | pd.Series`
  - Shift each date by k trading days on the grid; out-of-bounds clipped to ends, yielding NA where date not in grid.

- `align_to_grid(df: pd.DataFrame, grid: pd.DatetimeIndex, how: Literal['inner','left'] = 'left') -> pd.DataFrame`
  - Reindex MultiIndex `[date, ticker]` data to the grid × tickers; `left` keeps full grid, `inner` keeps intersection.

2) `src/returns.py`

- `daily_simple_returns(df: pd.DataFrame, price_col: str = 'close') -> pd.Series`
  - Returns a MultiIndex Series aligned to input index with per-ticker `close/shift(close)-1`.

- `daily_log_returns(df: pd.DataFrame, price_col: str = 'close') -> pd.Series`
  - Per-ticker log returns.

- `forward_returns(df: pd.DataFrame, horizons: list[int] = [1,5,21], price_col: str = 'close') -> pd.DataFrame`
  - For evaluation only; columns `fwd_ret_{h}d`. No leakage into signals.

- `monthly_returns(df: pd.DataFrame, calendar: Literal['union','vnindex'] = 'union', indices_df: pd.DataFrame | None = None, price_col: str = 'close') -> pd.DataFrame`
  - DataFrame `[month_end, ticker, ret_1m]` on month-end grid; uses last observed close on or before each month-end per ticker.

- `eligible_monthly_returns(df: pd.DataFrame, monthly_flags: pd.DataFrame, calendar: Literal['union','vnindex'] = 'union', indices_df: pd.DataFrame | None = None, price_col: str = 'close') -> pd.DataFrame`
  - Joins `monthly_returns` with `[month_end, ticker, eligible]` and filters `eligible == True`.

Notes:
- All APIs expect the M1/M2 schema (MultiIndex `[date, ticker]`).
- Functions never alter raw prices; consumers should pass the cleaned frame from M1 to avoid anomalies.

---

## TDD Plan (New Tests)

Add focused, deterministic tests under `tests/`:

1) `tests/test_calendar_utils.py`
- Grid construction: union grid equals sorted unique dates; vnindex grid matches index loader dates.
- Month-ends: correct last trading day per month on sparse fixtures.
- nth trading day: returns NA if month has fewer than n days; otherwise exact match.
- Trading-day shift: shifting across month boundaries and clipping at grid bounds works as expected.

2) `tests/test_returns.py`
- Daily returns: per-ticker simple and log returns match hand calculations; first return is NA; no cross-ticker leakage.
- Forward returns: for horizons {1,5,21}, check correctness and ensure function is tagged “evaluation-only”.
- Monthly returns: month-end close-to-close matches ratio of last observed closes at/preceding month-ends; no look-ahead.
- Eligibility integration: join with a small `monthly_universe` from M2 and ensure only eligible rows remain.
- Calendar consistency: monthly returns produced under both `union` and `vnindex` match expected dates on fixtures.

Where practical, reuse fixtures from existing tests (M1/M2) to ensure integration.

---

## Acceptance Criteria

- APIs implemented as specified in `src/calendar.py` and `src/returns.py` with type hints and concise docstrings.
- All new tests pass: `poetry run pytest -q` remains green, including existing M0–M2 tests.
- No look-ahead:
  - Daily and monthly return functions only use information up to the computation date.
  - Forward return utilities are clearly separated and not used in signal formation tests.
- Calendar correctness:
  - Month-end selection matches last grid day per month; shifting and nth-day utilities behave on boundary cases.
- Integration:
  - `eligible_monthly_returns` filters to M2 universe and preserves `[month_end, ticker]` ordering.

---

## Integration with M0, M1, M2

- M0 (Repro): no RNG; deterministic Pandas; keep tests deterministic and rely on `src.utils` when randomness is introduced by future modules.
- M1 (Ingest/Validation): returns consume cleaned OHLCV from `validate_ohlcv()`; indices from `load_indices()` optionally set the canonical calendar.
- M2 (Eligibility): calendar logic mirrors `filters.eligibility_flags`; `eligible_monthly_returns` consumes `monthly_universe`; daily filtering can use `filters.apply_eligibility` if needed.

---

## Implementation Notes

- Keep implementations minimal and composable: groupby–shift for daily returns; per-month sampling for monthly returns; shared calendar helpers for consistency.
- Avoid forward-filling across missing trading days for daily return computation; for monthly, use last known close at or before month-end.
- Do not add config files; make thresholds/behaviors explicit via function parameters.
- Respect repository style: absolute imports, type hints, 4-space indents, concise docstrings.

---

## Example Usage (Sketch)

```python
from src.data_io import load_ohlcv, validate_ohlcv, load_indices
from src.filters import eligibility_flags, monthly_universe
from src.returns import monthly_returns, eligible_monthly_returns

raw = load_ohlcv(["HSX/AAA.parquet", "HNX/BBB.parquet"])  # or discovered paths
clean, anoms = validate_ohlcv(raw)
indices = load_indices("vn_indices/")

# Calendar-aware monthly returns
mret = monthly_returns(clean, calendar="vnindex", indices_df=indices)

# Eligibility-gated monthly returns (M2 integration)
flags = eligibility_flags(clean, calendar="vnindex", indices_df=indices)
uni = monthly_universe(flags)
mret_elig = eligible_monthly_returns(clean, monthly_flags=uni, calendar="vnindex", indices_df=indices)
```

---

## Out of Scope (M3)

- Risk model and factor portfolio construction (future milestones).
- Transaction costs, slippage modeling, and execution calendar nuances.
- Corporate action adjustment logic (assumed handled upstream by data vendor; M1 validates basic continuity and anomalies).

---

## Quick Checklist

- Calendar utilities implemented and covered by tests.
- Daily and monthly returns implemented with no look-ahead.
- Eligibility integration tested and passing.
- All tests (existing + new) pass under `poetry run pytest -q`.

