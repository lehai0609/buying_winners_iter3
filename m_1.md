
# M1 — Data Ingest & Validation (OHLCV + Indices)

## Purpose

Stand up reliable OHLCV and index inputs for 2010–2025 with strict validation and no look‑ahead. Produce clean, typed, deduped parquet plus anomaly and coverage reports for downstream modules.

---

## Inputs

- **Files**:
  - **HSX**: folder `HSX/` containing per‑ticker parquet files. One file per stock; filename equals ticker, e.g., `AAA.parquet`.
  - **HNX**: folder `HNX/` with the same per‑ticker parquet layout as HSX.
  - **Indices**: folder `vnindice/` with three separate files for `VNINDEX`, `HNXINDEX`, and `VN30` (parquet or CSV).
- **Schema (raw files)**: `time, open, high, low, close, volume`. `time` formatted `YYYY-MM-DD`. No `ticker` column in files; loader infers `ticker` from the filename and adds it on ingest.
- **Types (on ingest)**: `time`→datetime64[ns] (UTC‑naive), prices/volume→numeric, `ticker`→uppercase string derived from filename.
- **Indices semantics**: daily close series for VNINDEX/HNXINDEX/VN30 aligned to the equity trading calendar at ingest.
- **Config**: `config/data.yml` declares `raw_dirs: {hsx, hnx, indices}` and per‑exchange filename globs.

---

## Outputs

- **Clean OHLCV**: `data/clean/ohlcv.parquet` indexed by `[date, ticker]`, sorted, typed.
- **No persisted index file**: indices are read directly from `vnindice/` and normalized in memory for alignment and benchmarks.
- **Coverage Report**: `data/clean/coverage_summary.csv` (by year: tickers, rows, missing days).
- **Anomalies Report**: `data/clean/anomalies.csv` (duplicates, invalid OHLC, extreme returns, NaN/zero volume, out‑of‑range open/close).
- **Logs**: human‑readable validation log with counts per rule.

---

## Validation Rules (assert or flag)

1. **Schema**: All required columns present; exact dtypes enforced.
2. **Uniqueness**: `(date, ticker)` must be unique; duplicates rejected.
3. **Price positivity**: `open, high, low, close > 0`.
4. **OHLC ordering**: `high ≥ max(open, close)` and `low ≤ min(open, close)` and `high ≥ low`.
5. **Volume**: allow zero/NaN but **flag**; do not drop rows here.
6. **Extreme daily moves**: compute `ret_d = close/close.shift(1) − 1`; flag `|ret_d| > 0.50`.
7. **Date range**: clip to `[2010‑01‑01, 2025‑08‑31]`.
8. **Index alignment**: VNINDEX and HNX‑INDEX calendars aligned to equities; no forward‑fill of returns.
9. **No look‑ahead**: validations may use only data ≤ the row date.

---

## TDD — Tests to Write (Red → Green → Refactor)

**tests/test\_data\_io.py**

- Loads small fixture → typed df, sorted, correct index.
- Duplicate `(date,ticker)` → raises.
- Missing required column → raises.
- Date filter `[start,end]` returns expected count.

**tests/test\_validation.py**

- Negative/zero prices detected.
- `high < low` detected.
- `open > high` or `close < low` flagged.
- NaN/zero volume counted in flags only.
- Extreme return >50% flagged.

**tests/test\_index\_loader.py**

- VNINDEX/HNX‑INDEX load; calendars align; no spurious fills.

**tests/test\_reports.py**

- Coverage summary totals by year correct on fixture.
- Anomalies report contains expected rows and columns.

---

## APIs (module contracts)

**data\_io.py**

```python
load_ohlcv(paths: list[str], start: str|date, end: str|date) -> pd.DataFrame  # [date,ticker] index
validate_ohlcv(df: pd.DataFrame) -> tuple[pd.DataFrame, pd.DataFrame]        # (clean_df, anomalies_df)
load_indices(dir_path: str, names: list[str] = ["VNINDEX","HNXINDEX","VN30"]) -> pd.DataFrame  # columns: date,index,close
get_index_series(indices_df: pd.DataFrame, name: str) -> pd.Series           # daily close for one index
```

**reports**

```python
write_coverage(df: pd.DataFrame, out_path: str) -> None
write_anomalies(anoms: pd.DataFrame, out_path: str) -> None
```

---

## CLI (script stub)

```bash
poetry run python scripts/make_clean.py \
  --inputs-dir HSX HNX \
  --indices-dir vnindice \
  --out-parquet data/clean/ohlcv.parquet
```

**Script responsibilities**

- Discover files from `config/data.yml`.
- Load OHLCV from HSX/HNX and load indices from `vnindice/` via `load_indices()`.
- Run validations and alignment checks.
- Emit parquet + reports + logs. Exit non‑zero if hard validations fail.

---

## Acceptance Criteria (M1 Done)

- Clean OHLCV parquet exists with non‑trivial row counts.
- Indices ingest passes checks: all three index series load, dates parse, overlap equity calendar, and no duplicates.
- All **hard** validations pass; **soft** issues logged in anomalies report.
- Coverage summary produced and reviewed.
- Tests above pass locally and in CI.

---

## Edge Cases & Policies

- **Trading halts / zero volume**: keep rows; downstream modules will handle.
- **Price limits (±7%)**: only flagged if implied by returns; no capping here.
- **Corporate actions**: assume pre‑adjusted closes; clusters of extremes trigger a data‑provider ticket.
- **Ticker changes / delistings**: preserve full history; no survivorship filtering in M1.

---

## Open Decisions to Confirm

- Final threshold for “extreme move” (default 50%).
- Whether to store `value` (turnover) if available.
- File layout convention under `data/raw/` (by exchange vs by ticker).

---

## Index ingest (vnindice/)

**Assumptions**: three files named `VNINDEX.*`, `HNXINDEX.*`, `VN30.*` with columns `time, open, high, low, close, volume` and `time` formatted `YYYY-MM-DD`.

**Behavior**

1. Discover files in `vn_indices/` matching the expected names (case‑insensitive) and supported extensions {`.parquet`, `.csv`}.
2. Read each file; coerce dtypes; rename `time→date`.
3. Keep only `date` and `close`; add column `index` with the index name.
4. Concatenate to long form `[date, index, close]`; sort and drop duplicates.
5. Align calendar to equities for intersection dates; no forward‑fills.
6. Return `indices_df`; do not persist a combined file.

**Errors**

- Missing file for any required index → raise.
- Duplicate `date,index` → raise.
- Non‑monotonic dates after parse → raise.

---

## Quick Checklist

-

