# M2 — Eligibility & Cleaning (Vietnam-Specific)

## Purpose

Define and implement monthly tradable universe construction for Vietnam equities (HOSE/HNX) with Vietnam-specific quality and liquidity screens, while preserving raw data for auditability. The universe must be computed without look-ahead, on a per-formation-month basis, to feed downstream returns, momentum, and portfolio modules.

---

## Scope & Principles

- Exchanges: HOSE and HNX common stocks.
- Period: 2010–2025 (aligned with M1 ingest window).
- No look-ahead: all eligibility metrics at formation month t only use information up to and including t (or a defined trailing window ending at t).
- Cleaning vs Eligibility: M1 retains rows and flags anomalies; M2 uses those flags and additional rules to decide tradable eligibility but does not drop rows from the clean OHLCV dataset.

---

## Inputs

- `OHLCV`: Daily, MultiIndex DataFrame `[date, ticker]` with columns `[open, high, low, close, volume]`, as produced by:
  - `src.data_io.load_ohlcv()`
  - `src.data_io.validate_ohlcv()` → `(clean_df, anomalies_df)`
- Optional reference index calendar for grid alignment:
  - `src.data_io.load_indices()` → long `[date, index, close]` to optionally derive a reference trading calendar (e.g., VNINDEX) if desired.
- Config (for local runs/scripts only; unit tests pass parameters directly):
  - Thresholds may later move to `config/strategy.yml`; for now, pass explicitly to functions.

---

## Outputs

- `eligibility.parquet` (daily flags, optional): MultiIndex `[date, ticker]` with columns:
  - `eligible` (bool): final eligibility at date.
  - Component flags (bool): `min_history_ok`, `price_ok`, `adv_ok`, `nontrading_ok`, `quality_ok`.
  - Diagnostics (numeric): `days_history`, `days_traded_in_window`, `nontrading_days`, `adv_vnd`.
- `monthly_universe.parquet` (required): Month-end table `[month_end, ticker, eligible]` for formation months.
- `eligibility_summary.csv` (optional diagnostics): per-month counts of eligible tickers and distribution snapshots (min/median/max ADV, nontrading days).
- Soft anomalies from M1 remain in `data/clean/anomalies.csv` (do not duplicate); M2 may produce additional universe-level diagnostics, not hard errors.

---

## Eligibility Rules (Vietnam-Specific)

Evaluate at each formation month-end `t` using only data available up to `t`:

1. Minimum history: at least 6 months of trading history prior to or including `t`. Implement as `min_history_days >= 126` trading days (≈6 months) within lookback window ending at `t`.
2. Price threshold: last available close on or before `t` ≥ 1,000 VND ⇒ `price_ok`.
3. Liquidity (ADV): average daily trading value ≥ 100,000,000 VND over trailing window ending at `t` ⇒ `adv_ok`.
   - Daily trading value uses scaled prices: `scaled_close * volume`, where `scaled_close = close * price_scale`.
   - If raw prices are in kVND, set `price_scale=1000` to evaluate thresholds in VND.
   - Rolling window default: 126 trading days (≈6 months); `min_periods=60` to be lenient in the first months after IPO.
4. Non-trading days limit: ≤ 15 non-trading days within the same trailing window ending at `t` ⇒ `nontrading_ok`.
   - Non-trading day = missing OHLCV row on a grid trading day OR present row with `volume == 0`.
   - Grid trading days = union of observed dates in `OHLCV` (optionally intersected with VNINDEX dates — selectable behavior).
5. Quality screen: if any OHLC ordering or non-positive price anomalies occur within the window, mark `quality_ok = False` (conservative). Volume anomalies alone do not fail quality (handled by nontrading rule).
6. Remove halted/suspended periods from eligibility only (do not drop data);
   - Rows with `volume == 0` count toward `nontrading_days` and may disqualify if threshold exceeded.

Final eligibility at `t`:

```
eligible = min_history_ok & price_ok & adv_ok & nontrading_ok & quality_ok
```

Parameters (defaults; passed explicitly, not via config in M2):
- `lookback_days: int = 126`
- `min_history_days: int = 126`
- `min_price_vnd: float = 1000.0`
- `min_adv_vnd: float = 100_000_000.0`
- `max_nontrading_days: int = 15`
- `calendar: {"union", "vnindex"} = "union"` (grid construction method)

---

## Algorithms & Computation Details

- Trading grid: derive `grid_dates` by one of:
  - Union: `sorted(unique(df.index.get_level_values("date")))`.
  - VNINDEX: `get_index_series(indices_df, "VNINDEX").index`.
- Daily trading value: `turnover_vnd = scaled_close * volume`, with `scaled_close = close * price_scale`.
- Rolling ADV: grouped by `ticker`, compute `turnover_vnd.rolling(window=lookback_days, min_periods=60).mean()` and align to date.
- History length: per `ticker`, count observed trading days ≤ `t` (or within window).
- Non-trading days: within the last `lookback_days` grid dates ≤ `t`, count days with either missing row or `volume == 0`.
- Quality flags: for the window ≤ `t`, fail if any OHLC ordering violation or non-positive price `open/high/low/close <= 0` occurred.
- Month-ends: define formation dates by calendar month-ends present in the grid (last available grid day per month).
- No look-ahead: all rolling/aggregations must be computed via `groupby(ticker)` with `.rolling(...)` or explicit windowing that does not peek after `t`.

---

## Units & Scaling

- Raw price units may be kVND in source parquet. M1 does not change units.
- M2 introduces `price_scale` to normalize units for eligibility checks:
  - `scaled_close = close * price_scale` (e.g., `price_scale=1000` converts kVND → VND).
  - ADV and `price_ok` use `scaled_close`; diagnostics column `adv_vnd` reflects the scaled units.

---

## Module APIs (Contracts)

New module: `src/filters.py`

```python
import pandas as pd
from typing import Literal

GridMode = Literal["union", "vnindex"]

def compute_turnover(df: pd.DataFrame) -> pd.Series:
    """Return a daily Series aligned to df index with trading value: close * volume (pre-scaling)."""

def rolling_adv(
    df: pd.DataFrame,
    window: int = 126,
    min_periods: int = 60,
) -> pd.Series:
    """Return a daily Series of rolling average trading value per ticker (in native units of close*volume)."""

def eligibility_flags(
    df: pd.DataFrame,
    lookback_days: int = 126,
    min_history_days: int = 126,
    min_price_vnd: float = 1000.0,
    min_adv_vnd: float = 100_000_000.0,
    max_nontrading_days: int = 15,
    calendar: GridMode = "union",
    indices_df: pd.DataFrame | None = None,
    price_scale: float = 1.0,
    anomalies_df: pd.DataFrame | None = None,
) -> pd.DataFrame:
    """
    Compute per-day flags and a final 'eligible' boolean at each date per ticker.
    Returns a DataFrame with index [date, ticker] and columns:
    [eligible, min_history_ok, price_ok, adv_ok, nontrading_ok, quality_ok,
     days_history, days_traded_in_window, nontrading_days, adv_vnd].
    If anomalies_df is provided (from validate_ohlcv), use it to compute quality_ok.
    Notes: adv_vnd reflects the scaled units after applying price_scale.
    """

def monthly_universe(
    flags: pd.DataFrame,
) -> pd.DataFrame:
    """Downsample eligibility to formation month-ends: columns [month_end, ticker, eligible]."""

def apply_eligibility(
    df: pd.DataFrame,
    monthly_flags: pd.DataFrame,
) -> pd.DataFrame:
    """Filter df to rows that belong to eligible tickers at their formation month; preserves index and columns."""
```

Notes:
- Inputs expect M1 output schema (MultiIndex `[date, ticker]`).
- For tests and integration, thresholds are function parameters (no new config files added in M2).

---

## Integration with M0 & M1

- With M0 (Repro): deterministic behavior; no RNG usage; pure Pandas code.
- With M1 (Ingest & Validation):
  - Consume `load_ohlcv` output and optionally run `validate_ohlcv` before filters to ensure correct schema and anomalies available for `quality_ok`.
  - Use `reports.write_coverage` on filtered or unfiltered data as needed; anomalies from M1 remain the single source of truth.
- Downstream dependencies (pre-wiring for M3/M4):
  - `M1 → M2`: eligibility uses loaded & validated data.
  - `M2 → M3`: returns are computed for eligible tickers per formation schedule.

---

## TDD Plan (New Tests)

Create `tests/test_filters.py` with deterministic fixtures that cover:

- Price threshold screen:
  - Given tickers with last close below/above 1,000 VND at `t`, only the latter is `price_ok`.
- Minimum history screen:
  - IPO with <126 trading days fails `min_history_ok` at early months; passes once threshold reached.
- ADV screen:
  - Construct synthetic `scaled_close * volume` such that ADV is just below or above 100M VND; check `adv_ok` responds accordingly.
  - Verify rolling computation does not use future dates (shifted references return same result).
- Non-trading days screen:
  - Within a 126-day window, inject 16 zero-volume or missing days → `nontrading_ok == False`; with 15 days → `True`.
  - Ensure “grid” definition counts missing rows as non-trading.
- Quality screen from M1 anomalies:
  - Any OHLC ordering violation or non-positive price within window flips `quality_ok == False`.
- Final eligibility and monthly universe:
  - Verify `eligible` equals logical AND of components.
  - `monthly_universe` picks last available grid day per month; eligible tickers at that day are returned.
- No look-ahead:
  - Modify prices after formation date and show past universe remains unchanged.

Each test should use minimal, explicit fixtures and assert both the boolean flags and core diagnostics (e.g., `adv_vnd`, `nontrading_days`).

---

## Acceptance Criteria

- Module `src/filters.py` exposes the APIs above and passes all new tests in `tests/test_filters.py`.
- Universe is computed per formation month-end without look-ahead; checks using shifted/altered future data do not change past eligibility.
- Flags behave as specified on synthetic fixtures:
  - `price_ok` threshold at 1,000 VND.
  - `min_history_ok` at 126 days.
  - `adv_ok` at 100M VND (using `scaled_close * volume`).
  - `nontrading_ok` with ≤15 non-trading days; zero-volume contributes as non-trading.
  - `quality_ok` fails on OHLC ordering or non-positive prices.
  - `price_scale` equivalence holds: `price_scale=1000` with VND thresholds matches `price_scale=1` with thresholds in kVND.
- Optional artifacts (if wired in `scripts/make_clean.py`):
  - `data/clean/monthly_universe.parquet` exists and has plausible counts.
  - `eligibility_summary.csv` contains at least `[month_end, eligible_count]`.
- Existing M1 tests remain green (no changes to `config/data.yml` schema or M1 APIs).

---

## Edge Cases & Policies

- Recent IPOs: pass `adv_ok` only when sufficient days exist (`min_periods`) and average crosses threshold.
- Halts/Suspensions: rows with `volume == 0` count toward `nontrading_days`; eligibility may fail for that formation.
- Corporate actions: spikes do not affect eligibility except through ADV; quality screen catches non-positive prices or OHLC violations.
- Sparse tickers: persistent missing rows will fail `nontrading_ok`.
- Calendar choice:
  - Default to union of observed dates; allow `vnindex` calendar if provided via `indices_df` (implementation must document the choice used).

---

## Implementation Notes (Minimal Wiring)

- Do not add new config files in M2. Keep thresholds as function parameters for tests. Move to `strategy.yml` in later milestones.
- Keep `scripts/make_clean.py` optional: if updated, add a flag to output `monthly_universe.parquet` via `eligibility_flags()` + `monthly_universe()`; do not change existing outputs.
- Follow repository style: absolute imports from `src`, type hints, and concise docstrings.

---

## CLI & Scripts

- Primary (new) CLI stub: `scripts/make_universe.py`
  - Purpose: Run `src/filters.py` to compute daily flags and the monthly formation universe from M1-cleaned OHLCV.
  - Key args:
    - `--in-parquet`: path to M1 output (default: `data/clean/ohlcv.parquet`).
    - `--indices-dir`: optional indices dir (default: `vn_indices/`) when `--calendar vnindex`.
    - `--flags-parquet`: output daily eligibility flags parquet (default: `data/clean/eligibility.parquet`).
    - `--universe-parquet`: output monthly universe parquet (default: `data/clean/monthly_universe.parquet`).
    - Thresholds: `--lookback-days`, `--min-history-days`, `--min-price-vnd`, `--min-adv-vnd`, `--max-nontrading`, `--calendar {union,vnindex}`.
    - Scaling: `--price-scale` (e.g., 1000 for kVND->VND).
    - `--dry-run`, `--verbose`.
  - Example:
    ```bash
    poetry run python scripts/make_universe.py \
      --in-parquet data/clean/ohlcv.parquet \
      --indices-dir vn_indices \
      --flags-parquet data/clean/eligibility.parquet \
      --universe-parquet data/clean/monthly_universe.parquet \
      --lookback-days 126 --min-history-days 126 \
      --min-price-vnd 1000 --min-adv-vnd 100000000 \
      --max-nontrading 15 --calendar union --price-scale 1000 --verbose
    ```

- Alternative (future wiring): extend `scripts/make_clean.py` with an optional `--write-universe` switch and the same thresholds to produce universe artifacts in a single pass (M1+M2). Keep current M1 outputs unchanged by default.

Reminder (M1 validation pipeline):
- Module: `src.data_io.validate_ohlcv` performs input validation and returns `(clean_df, anomalies_df)`.
- CLI: `scripts/make_clean.py` orchestrates loading (`load_ohlcv`), validation (`validate_ohlcv`), index ingest (`load_indices`), and writes:
  - `data/clean/ohlcv.parquet`, `coverage_summary.csv`, `anomalies.csv`, and `hard_errors.csv`.

---

## Example Usage (Pseudo-code)

```python
from src.data_io import load_ohlcv, validate_ohlcv
from src.filters import eligibility_flags, monthly_universe

# Load and validate
df = load_ohlcv(paths)
clean, anoms = validate_ohlcv(df)

# Compute flags and monthly universe (e.g., prices in kVND → evaluate thresholds in VND by scaling)
flags = eligibility_flags(
    clean,
    lookback_days=126,
    min_history_days=126,
    min_price_vnd=1_000.0,
    min_adv_vnd=100_000_000.0,
    max_nontrading_days=15,
    price_scale=1000.0,
)
uni = monthly_universe(flags)
```

---

## Deliverables Checklist

- `src/filters.py` with the APIs and logic above.
- `tests/test_filters.py` covering rule components, final eligibility, no look-ahead, and monthly universe selection.
- Optional script updates to persist `monthly_universe.parquet` and a summary CSV.
- All tests pass: `pytest -q`.

## Usage
poetry run python scripts/make_universe.py --in-parquet data/clean/ohlcv.parquet --indices-dir vn_indices --anomalies-csv data/clean/anomalies.csv --flags-parquet data/clean/eligibility.parquet --universe-parquet data/clean/monthly_universe.parquet --lookback-days 126 --min-history-days 126 --min-price-vnd 1000 --min-adv-vnd 100000000 --max-nontrading 15 --calendar union --price-scale 1000 --verbose
