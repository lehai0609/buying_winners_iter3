# M6: Trading Frictions (Costs, Slippage, Impact)

## Purpose
Convert gross portfolio trades into net returns by modeling realistic trading frictions for Vietnam equities. Apply per-side fees, slippage as a function of participation vs. ADV, and optional impact. Produce deterministic, auditable cost attribution per trade and per month.

## Objectives
- Implement cost models: commissions/fees (per-side bps), linear slippage vs. participation to ADV, optional impact.
- Use calendar-aware ADV computed from daily OHLCV with a trailing window ending at formation month.
- Enrich trades with cost fields and aggregate monthly cost summaries.
- Keep behavior deterministic and configurable; unit test edge cases and caps.

## Scope
- In-scope: cost configuration, ADV computation, trade cost attribution, per-trade and per-month outputs, tests, docs, optional CLI.
- Out-of-scope: PnL simulation and execution timing choices (M7), reporting/plots (M10).

---

## Inputs and Outputs

### Inputs
- `data/clean/portfolio_trades.parquet` (from M5): monthly trades with at least
  - `month_end` (datetime64[ns])
  - `ticker` (str)
  - `prev_weight` (float)
  - `target_weight` (float)
  - `trade_dW` (float; delta weight)
  - `side` ("buy"|"sell"|"none")
- `data/clean/ohlcv.parquet` (from M1): daily data to compute ADV in value terms
  - MultiIndex `[date, ticker]`; columns include `close` (float), `volume` (int/float)
- `config/data.yml` additions (validated via Pydantic; may later move to `config/backtest.yml`):
  - `costs.per_side_bps` (float >= 0; default `25.0`) — fees/commissions per side, in bps of notional traded.
  - `costs.use_adv` (bool; default `true`) — enable ADV-based slippage/impact. If `false`, only fixed per-side bps apply unless `costs.slippage_per_turnover_bps` is provided.
  - `costs.adv_window_days` (int >= 5; default `21`) — trailing trading days for ADV.
  - `costs.min_adv_trading_days` (int in [1, adv_window_days]; default `15`) — minimum valid days to accept an ADV estimate.
  - `costs.slippage_bps_per_1pct_adv` (float >= 0; default `2.0`) — linear slippage slope per 1% of ADV participation.
  - `costs.slippage_cap_bps` (float >= 0; default `100.0`) — per-trade slippage cap.
  - `costs.impact_model` (enum: `none`|`threshold`; default `none`).
  - `costs.impact_threshold_pct_adv` (float > 0; default `10.0`) — apply impact if participation ≥ this threshold (only if `impact_model=threshold`).
  - `costs.impact_bps` (float >= 0; default `10.0`) — flat bps added when above threshold.
  - `costs.capital_vnd` (float > 0; optional) — portfolio NAV used to convert weights to notional for ADV participation. Required when `use_adv=true` and ADV-based slippage/impact are enabled.
  - `costs.slippage_per_turnover_bps` (float >= 0; optional, default `0.0`) — fallback slippage rate per unit turnover when `use_adv=false`.

Notes
- When `costs.use_adv=true`, `costs.capital_vnd` is required to compute participation vs. ADV. In M7, this will live under `backtest.capital` and be sourced from `config/backtest.yml`.
- ADV is in value terms: `ADV_value = mean(close * volume)` over the trailing window aligned to `month_end`.

### Outputs
- Parquet: `data/clean/portfolio_trades_costed.parquet` — one row per `month_end,ticker` with enriched cost attribution:
  - `prev_weight`, `target_weight`, `trade_dW`, `side`
  - `adv_value` (float; VND per day)
  - `participation_pct_adv` (float; %ADV)
  - `fees_bps` (float)
  - `slippage_bps` (float)
  - `impact_bps` (float)
  - `total_cost_bps` (float; `fees_bps + slippage_bps + impact_bps`)
  - `notional_traded_vnd` (float; `|trade_dW| * capital_vnd` if provided)
- CSV: `data/clean/costs_summary.csv` — per `month_end` aggregates:
  - `gross_turnover` (float; `0.5 * sum |trade_dW|`)
  - `fees_bps`, `slippage_bps`, `impact_bps`, `total_cost_bps` (portfolio-weighted averages); and totals in `bps_x_turnover` if needed
  - `n_trades`, `n_buys`, `n_sells`, `n_capped_slippage`

---

## Algorithm Details
1. Align monthly trades and ADV window
   - For each `month_end = t`, gather daily OHLCV up to and including `t`.
   - Compute `ADV_value_{i,t}` as the mean of `close*volume` over the last `adv_window_days` with at least `min_adv_trading_days` valid observations. If insufficient, mark `adv_missing=true` and set `ADV_value` to NaN.
2. Compute per-name participation and notional (if capital provided)
   - `notional_traded_vnd_{i,t} = |trade_dW_{i,t}| * capital_vnd` (if `capital_vnd` given; else leave NaN).
   - `participation_pct_adv_{i,t} = 100 * notional_traded_vnd / ADV_value` if both available; else NaN.
3. Fees/commissions (per side)
   - `fees_bps_{i,t} = costs.per_side_bps * 1_{|trade_dW|>0}`; may also scale by `|trade_dW|` if modeling fees in return space. For this milestone we apply fees in return per weight: `fees_bps = per_side_bps * |trade_dW|` so that portfolio-level cost is `sum(fees_bps)` in bps-return units.
4. Slippage
   - If `use_adv=true` and `participation_pct_adv` available:
     - `slippage_bps_raw = costs.slippage_bps_per_1pct_adv * participation_pct_adv`.
     - `slippage_bps = min(slippage_bps_raw, costs.slippage_cap_bps)`.
   - Else if `use_adv=false`:
     - `slippage_bps = costs.slippage_per_turnover_bps * |trade_dW|` (weight-space approximation).
   - Else (ADV missing): mark and set `slippage_bps = costs.slippage_cap_bps` (conservative cap).
5. Impact
   - If `impact_model=none`: `impact_bps = 0`.
   - If `impact_model=threshold` and `participation_pct_adv >= impact_threshold_pct_adv`: `impact_bps = costs.impact_bps`; else `0`.
6. Totals and aggregation
   - `total_cost_bps_{i,t} = fees_bps + slippage_bps + impact_bps`.
   - Monthly summary aggregates both the portfolio-weighted averages and counts of capped or missing ADV. Portfolio-weighted average can be computed as `sum(total_cost_bps_{i,t})` because inputs are already scaled by `|trade_dW|` in bps-return units.

Edge cases
- `trade_dW = 0` → all cost components are 0.
- Missing ADV or zero ADV → use `slippage_cap_bps` and flag in output (optional `adv_missing` boolean) to avoid division by zero.
- Extremely illiquid names with very high participation → slippage is capped.
- Startup months with partial cohorts → turnover and costs reflect actual `trade_dW`; no redistribution beyond M5 rules.

Determinism
- All computations are pure functions of inputs/config and calendar alignment; no RNG.

---

## Config Changes (Pydantic)
Extend the existing config model to include a `costs` section in `config/data.yml` (temporary; later to be moved to `config/backtest.yml`).

Validation rules
- `per_side_bps >= 0`, `slippage_bps_per_1pct_adv >= 0`, `slippage_cap_bps >= 0`, `impact_bps >= 0`.
- `adv_window_days >= 5`; `1 <= min_adv_trading_days <= adv_window_days`.
- If `use_adv=true` → `capital_vnd` must be provided and `> 0`.
- If `impact_model=threshold` → require `impact_threshold_pct_adv > 0`.

Backward compatibility
- If `costs` omitted, default to fees-only with `per_side_bps=25.0`, `use_adv=false` so existing workflows remain runnable.

---

## APIs and I/O
Add `src/costs.py`:

```python
def compute_monthly_adv(ohlcv: pd.DataFrame, month_ends: pd.Series,
                        window_days: int, min_days: int) -> pd.DataFrame:
    """Return DataFrame indexed by [month_end, ticker] with column `adv_value`."""

def apply_trading_costs(trades: pd.DataFrame, adv: pd.DataFrame | None,
                        config: CostsConfig) -> tuple[pd.DataFrame, pd.DataFrame]:
    """Return (trades_costed, monthly_summary)."""
```

CLI (optional): `scripts/compute_costs.py`
- Args: `-c/--config` (default `config/data.yml`), `--dry-run`.
- Behavior: loads trades and OHLCV, computes ADV and costed trades, writes outputs, prints summary (`months`, `avg turnover`, `avg total_cost_bps`).

---

## Tests
Create `tests/test_costs.py` with deterministic, focused cases.

- Unit: zero trades
  - Given `trade_dW=0` across names, all cost components are zero.
- Unit: doubling turnover
  - For fixed config, doubling all `|trade_dW|` doubles total fees and weight-space slippage.
- Unit: ADV-based slippage linearity
  - With `capital_vnd` and synthetic ADV, `slippage_bps` scales linearly with `participation_pct_adv` until capped.
- Unit: slippage cap
  - Very large `|trade_dW|` or tiny ADV triggers `slippage_cap_bps`.
- Unit: impact threshold
  - Below threshold → `impact_bps=0`; above threshold → equals configured impact.
- Integration: enrich trades
  - Small synthetic `portfolio_trades.parquet` + daily OHLCV produce `portfolio_trades_costed.parquet` and `costs_summary.csv` with expected schemas and spot-checked values.

Testing helpers
- Use `tmp_path` for temp I/O; keep fixtures tiny; assert types/schemas; avoid network.

---

## Acceptance Criteria
- Config model validates `costs.*` fields with defaults and constraints.
- ADV computation aligns to month-end with required window and missing-data rules.
- Cost attribution applied per trade with correct caps and threshold logic.
- Outputs written to `data/clean/portfolio_trades_costed.parquet` and `data/clean/costs_summary.csv` with documented schemas.
- Deterministic results: identical inputs/config → identical outputs.
- `poetry run pytest -k costs -q` passes for new tests.

---

## Integration with Previous Milestones
- M5: Consumes `portfolio_trades.parquet` produced by portfolio construction.
- M1/M2: Uses clean OHLCV for ADV; respects any upstream hard-error exclusions.
- M7: Backtester will consume `total_cost_bps` to produce net returns; `capital_vnd` can migrate to `config/backtest.yml`.

---

## Non-Functional Requirements
- Performance: vectorized pandas; compute ADV and cost attribution for ~thousands of names over 15+ years within seconds to a few minutes on a laptop.
- Determinism: no randomness; pure functions.
- Robustness: defensive caps; clear flags on ADV missing; no crashes on edge cases.

---

## Implementation Notes
- Treat all cost fields in bps-return space to integrate cleanly with portfolio weights; when capital is provided, also emit notional and participation diagnostics.
- Align ADV to the formation month-end used in M4/M5; the execution timing (e.g., T+2) will be modeled in M7.
- Keep cost calculation orthogonal to selection/weights; no weight redistribution here.

---

## Deliverables
- Code: `src/costs.py` implementing ADV and cost attribution; config model updates.
- CLI: `scripts/compute_costs.py` (optional).
- Tests: `tests/test_costs.py` with unit and integration coverage.
- Data: `data/clean/portfolio_trades_costed.parquet`, `data/clean/costs_summary.csv`.
- Docs: This `m_6.md` and function docstrings.

